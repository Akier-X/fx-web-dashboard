<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXå–å¼•ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            color: #333;
        }

        .metric-value.positive {
            color: #10b981;
        }

        .metric-value.negative {
            color: #ef4444;
        }

        .metric-value.warning {
            color: #f59e0b;
        }

        .big-number {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .big-number.up {
            color: #10b981;
        }

        .big-number.down {
            color: #ef4444;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .comparison-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .trade-log {
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
        }

        .trade-log-item {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .timestamp {
            color: #9ca3af;
            font-size: 0.85em;
        }

        .update-time {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ FXè‡ªå‹•å–å¼•ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot"></div>
                <span><strong>ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒä¸­</strong></span>
            </div>
            <div class="status-item">
                <span id="update-indicator">æœ€çµ‚æ›´æ–°: èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
        </div>

        <!-- å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯ -->
        <div class="grid">
            <div class="card">
                <h2>ğŸ“Š å›ºå®šãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰</h2>
                <div id="fixed-task-info" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="card">
                <h2>ğŸ§  é©å¿œå­¦ç¿’ãƒ¢ãƒ‡ãƒ«ï¼ˆNEW!ï¼‰</h2>
                <div id="adaptive-task-info" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- æœ€æ–°äºˆæ¸¬ -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>ğŸ¯ æœ€æ–°äºˆæ¸¬çµæœ</h2>
            <div id="prediction-info" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <!-- ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>ğŸ“Š USD/JPY ä¾¡æ ¼æ¨ç§»ï¼ˆéå»6ãƒ¶æœˆï¼‰</h2>
            <div style="text-align: center;">
                <img id="price-chart" src="/chart_image?t=0" alt="USD/JPYä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                    <button onclick="refreshChart()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        ğŸ”„ ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
                    </button>
                </p>
            </div>
        </div>

        <!-- å¸‚å ´çµ±è¨ˆã¨é©å¿œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
        <div class="grid">
            <div class="card">
                <h2>ğŸ“ˆ å¸‚å ´çµ±è¨ˆï¼ˆéå»24æ™‚é–“ï¼‰</h2>
                <div id="market-stats" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="card">
                <h2>âš™ï¸ é©å¿œçš„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h2>
                <div id="adaptive-params" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ æ¯”è¼ƒ -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>ğŸ” å›ºå®šãƒ¢ãƒ‡ãƒ« vs é©å¿œå­¦ç¿’ãƒ¢ãƒ‡ãƒ«</h2>
            <div id="comparison-table" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <!-- å–å¼•å±¥æ­´ -->
        <div class="card">
            <h2>ğŸ“ å–å¼•ãƒ­ã‚°ï¼ˆæœ€æ–°20ä»¶ï¼‰</h2>
            <div id="trade-history" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="update-time" id="last-update">
            è‡ªå‹•æ›´æ–°: 30ç§’ã”ã¨
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–¢æ•°
        async function updateDashboard() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // ã‚¿ã‚¹ã‚¯çŠ¶æ…‹æ›´æ–°
                updateTaskInfo('fixed-task-info', data.tasks.fixed_model);
                updateTaskInfo('adaptive-task-info', data.tasks.adaptive_model);

                // äºˆæ¸¬æ›´æ–°
                updatePrediction(data.prediction);

                // å¸‚å ´çµ±è¨ˆæ›´æ–°
                updateMarketStats(data.market_stats);

                // é©å¿œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ›´æ–°
                updateAdaptiveParams(data.adaptive_params);

                // ã‚·ã‚¹ãƒ†ãƒ æ¯”è¼ƒæ›´æ–°
                updateComparison(data.system_comparison);

                // å–å¼•å±¥æ­´æ›´æ–°
                updateTradeHistory(data.trade_history);

                // æ›´æ–°æ™‚åˆ»è¡¨ç¤º
                const now = new Date().toLocaleString('ja-JP');
                document.getElementById('update-indicator').textContent = `æœ€çµ‚æ›´æ–°: ${now}`;

            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function updateTaskInfo(elementId, taskData) {
            const html = `
                <div class="metric">
                    <span class="metric-label">ã‚¿ã‚¹ã‚¯ID</span>
                    <span class="metric-value"><span class="badge info">${taskData.task_id}</span></span>
                </div>
                <div class="metric">
                    <span class="metric-label">çŠ¶æ…‹</span>
                    <span class="metric-value"><span class="badge success">${taskData.status === 'running' ? 'å®Ÿè¡Œä¸­' : taskData.status}</span></span>
                </div>
                <div class="metric">
                    <span class="metric-label">é–‹å§‹æ™‚åˆ»</span>
                    <span class="metric-value">${taskData.started}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ã‚¿ã‚¤ãƒ—</span>
                    <span class="metric-value">${taskData.type}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">è©³ç´°</span>
                    <span class="metric-value" style="font-size: 0.9em;">${taskData.description}</span>
                </div>
            `;
            document.getElementById(elementId).innerHTML = html;
        }

        function updatePrediction(pred) {
            if (pred.error) {
                document.getElementById('prediction-info').innerHTML = `<p class="loading">ã‚¨ãƒ©ãƒ¼: ${pred.error}</p>`;
                return;
            }

            const directionClass = pred.direction === 'ä¸Šæ˜‡' ? 'up' : 'down';
            const confidencePercent = (pred.confidence * 100).toFixed(2);
            const thresholdPercent = (pred.confidence_threshold * 100).toFixed(0);
            const confidenceStatus = pred.confidence >= pred.confidence_threshold ? 'positive' : 'negative';
            const returnStatus = Math.abs(pred.expected_return) >= pred.return_threshold ? 'positive' : 'negative';

            const html = `
                <div class="big-number ${directionClass}">
                    ${pred.direction === 'ä¸Šæ˜‡' ? 'â¬†' : 'â¬‡'} ${pred.direction}
                </div>
                <div class="metric">
                    <span class="metric-label">ç¾åœ¨ä¾¡æ ¼ (USD/JPY)</span>
                    <span class="metric-value">${pred.current_price.toFixed(2)}å††</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ä¿¡é ¼åº¦</span>
                    <span class="metric-value ${confidenceStatus}">
                        ${confidencePercent}% ${pred.confidence >= pred.confidence_threshold ? 'âœ“ OK' : 'âœ— NG (é–¾å€¤: ' + thresholdPercent + '%)'}
                    </span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${confidencePercent}%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³</span>
                    <span class="metric-value ${returnStatus}">
                        ${pred.expected_return.toFixed(4)}% ${Math.abs(pred.expected_return) >= pred.return_threshold ? 'âœ“ OK' : 'âœ— NG (é–¾å€¤: ' + pred.return_threshold + '%)'}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">å–å¼•åˆ¤å®š</span>
                    <span class="metric-value">
                        ${pred.will_trade ?
                            '<span class="badge success">å–å¼•å®Ÿè¡Œ</span>' :
                            '<span class="badge warning">å–å¼•è¦‹é€ã‚Š</span>'}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ›´æ–°æ™‚åˆ»</span>
                    <span class="metric-value">${pred.timestamp}</span>
                </div>
            `;
            document.getElementById('prediction-info').innerHTML = html;
        }

        function updateMarketStats(stats) {
            if (stats.error) {
                document.getElementById('market-stats').innerHTML = `<p class="loading">ã‚¨ãƒ©ãƒ¼: ${stats.error}</p>`;
                return;
            }

            const changeClass = stats['24h_change'] >= 0 ? 'positive' : 'negative';
            const changeSymbol = stats['24h_change'] >= 0 ? 'â¬†' : 'â¬‡';

            const html = `
                <div class="metric">
                    <span class="metric-label">24æ™‚é–“å¤‰å‹•</span>
                    <span class="metric-value ${changeClass}">${changeSymbol} ${stats['24h_change'].toFixed(2)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£</span>
                    <span class="metric-value">${stats.volatility.toFixed(2)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æœ€é«˜å€¤</span>
                    <span class="metric-value">${stats.high.toFixed(2)}å††</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æœ€å®‰å€¤</span>
                    <span class="metric-value">${stats.low.toFixed(2)}å††</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ç¾åœ¨å€¤</span>
                    <span class="metric-value">${stats.current.toFixed(2)}å††</span>
                </div>
            `;
            document.getElementById('market-stats').innerHTML = html;
        }

        function updateAdaptiveParams(params) {
            if (params.error) {
                document.getElementById('adaptive-params').innerHTML = `<p class="loading">ã‚¨ãƒ©ãƒ¼: ${params.error}</p>`;
                return;
            }

            const html = `
                <div class="metric">
                    <span class="metric-label">Kellyåˆ†æ•°</span>
                    <span class="metric-value">${params.kelly_fraction.toFixed(2)} <small>(ç¯„å›²: 0.30-0.65)</small></span>
                </div>
                <div class="metric">
                    <span class="metric-label">æœ€å¤§ãƒ¬ãƒãƒ¬ãƒƒã‚¸</span>
                    <span class="metric-value">${params.max_leverage.toFixed(1)}x <small>(ç¯„å›²: 3.0x-9.0x)</small></span>
                </div>
                <div class="metric">
                    <span class="metric-label">ä¿¡é ¼åº¦é–¾å€¤</span>
                    <span class="metric-value">${(params.confidence_threshold * 100).toFixed(0)}% <small>(ç¯„å›²: 60-70%)</small></span>
                </div>
                <div class="metric">
                    <span class="metric-label">å¸‚å ´ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£</span>
                    <span class="metric-value">${(params.volatility * 100).toFixed(2)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­¦ç¿’</span>
                    <span class="metric-value">
                        ${params.online_model_trained ?
                            '<span class="badge success">è¨“ç·´æ¸ˆã¿</span>' :
                            '<span class="badge warning">æœªè¨“ç·´ (' + params.update_buffer_size + '/50)</span>'}
                    </span>
                </div>
            `;
            document.getElementById('adaptive-params').innerHTML = html;
        }

        function updateComparison(comparison) {
            let html = '<table class="comparison-table"><thead><tr><th>æ©Ÿèƒ½</th><th>å›ºå®šãƒ¢ãƒ‡ãƒ«</th><th>é©å¿œå­¦ç¿’ãƒ¢ãƒ‡ãƒ«</th></tr></thead><tbody>';

            comparison.features.forEach(feature => {
                html += `<tr>
                    <td><strong>${feature.name}</strong></td>
                    <td>${feature.fixed}</td>
                    <td>${feature.adaptive}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('comparison-table').innerHTML = html;
        }

        function updateTradeHistory(history) {
            if (!history || history.length === 0) {
                document.getElementById('trade-history').innerHTML = '<p class="loading">å–å¼•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            let html = '<div class="trade-log">';
            history.reverse().forEach(item => {
                if (item.error) {
                    html += `<div class="trade-log-item">ã‚¨ãƒ©ãƒ¼: ${item.error}</div>`;
                } else {
                    html += `<div class="trade-log-item">
                        <div class="timestamp">${item.timestamp}</div>
                        <div>${item.message}</div>
                    </div>`;
                }
            });
            html += '</div>';
            document.getElementById('trade-history').innerHTML = html;
        }

        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°é–¢æ•°
        function refreshChart() {
            const chartImg = document.getElementById('price-chart');
            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
            chartImg.src = '/chart_image?t=' + new Date().getTime();
        }

        // åˆå›èª­ã¿è¾¼ã¿
        updateDashboard();

        // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
        setInterval(updateDashboard, 30000);

        // 5åˆ†ã”ã¨ã«ãƒãƒ£ãƒ¼ãƒˆã‚‚æ›´æ–°
        setInterval(refreshChart, 300000);
    </script>
</body>
</html>
